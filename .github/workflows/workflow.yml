name: deploy-toy-website-environments  
concurrency: toy-company  
  
on:  
  push:  
    branches:  
      - main  
  workflow_dispatch:  
    inputs:  
      environmentType:  
        required: true  
        type: string  
      resourceGroupName:  
        required: true  
        type: string  
  
env:  
  TESTCRED: ${{ secrets.AZURE_TEST_CRED }}  
  PRODCRED: ${{ secrets.AZURE_PROD_CRED }}  
  
permissions:  
  id-token: write  
  contents: read  
  
jobs:  
  
  # Lint the Bicep file.  
  lint:  
    runs-on: ubuntu-latest  
    steps:  
      - uses: actions/checkout@v2  
      - name: Install Bicep  
        run: |  
          curl -Lo bicep https://github.com/Azure/bicep/releases/latest/download/bicep-linux-x64  
          chmod +x ./bicep  
          sudo mv ./bicep /usr/local/bin/bicep  
      - name: Lint the Bicep file  
        run: bicep build ./deploy/main.bicep  
  
  # Deploy to the test environment.  
  deploy-test:  
    needs: lint
    runs-on: ubuntu-latest
    steps:  
      - uses: actions/checkout@v2  
      - name: Login to Azure  
        uses: azure/login@v1  
        with:  
          creds: ${{ env.TESTCRED }}  
      - name: Deploy to test environment  
        uses: ./.github/workflows/deploy.yml
        with:  
          environmentType: 'Test'
          resourceGroupName: 'ToyWebsiteTest'
  
  # Deploy to the production environment.  
  deploy-production:  
    needs: deploy-test  
    runs-on: ubuntu-latest  
    steps:  
      - uses: actions/checkout@v2  
      - name: Login to Azure  
        uses: azure/login@v1  
        with:  
          creds: ${{ env.PRODCRED }}  
      - name: Deploy to production environment  
        uses: ./.github/workflows/deploy.yml
        with:  
          environmentType: 'Production'
          resourceGroupName: 'ToyWebsiteProduction'
