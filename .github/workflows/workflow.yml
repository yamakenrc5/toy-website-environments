name: deploy-toy-website-environments  
concurrency: toy-company  
  
on:  
  push:  
    branches:  
      - main  
  workflow_dispatch:  
    inputs:  
      environmentType:  
        required: true  
        type: string  
      resourceGroupName:  
        required: true  
        type: string  
  
env:  
  TESTCRED: ${{ secrets.AZURE_TEST_CRED }}  
  PRODCRED: ${{ secrets.AZURE_PROD_CRED }}  
  
permissions:  
  id-token: write  
  contents: read  
  
jobs:  
  
  # Lint the Bicep file.  
  lint:  
    runs-on: ubuntu-latest  
    steps:  
      - uses: actions/checkout@v2  
      - name: Install Bicep  
        run: |  
          curl -Lo bicep https://github.com/Azure/bicep/releases/latest/download/bicep-linux-x64  
          chmod +x ./bicep  
          sudo mv ./bicep /usr/local/bin/bicep  
      - name: Lint the Bicep file  
        run: bicep build ./deploy/main.bicep  
  
  # Deploy to the test environment.  
  deploy-test:  
    runs-on: ubuntu-latest  
    needs: lint  
    steps:  
      - uses: actions/checkout@v2  
      - name: Login to Azure  
        uses: azure/login@v1  
        with:  
          creds: ${{ secrets.AZURE_TEST_CRED }}  
      - name: Deploy to test environment  
        uses: azure/arm-deploy@v1  
        with:  
          resource-group: ${{ github.event.inputs.resourceGroupName }}  
          template: ./deploy/main.bicep  
          parameters: |  
            {  
              "environmentType": {  
                "value": "${{ github.event.inputs.environmentType }}"  
              }  
            }  
          deployment-mode: Incremental  
  
  # Deploy to the production environment.  
  deploy-production:  
    runs-on: ubuntu-latest  
    needs: deploy-test  
    steps:  
      - uses: actions/checkout@v2  
      - name: Login to Azure  
        uses: azure/login@v1  
        with:  
          creds: ${{ secrets.AZURE_PROD_CRED }}  
      - name: Deploy to production environment  
        uses: azure/arm-deploy@v1  
        with:  
          resource-group: ${{ github.event.inputs.resourceGroupName }}  
          template: ./deploy/main.bicep  
          parameters: |  
            {  
              "environmentType": {  
                "value": "${{ github.event.inputs.environmentType }}"  
              }  
            }  
          deployment-mode: Incremental  
